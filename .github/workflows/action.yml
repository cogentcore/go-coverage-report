name: Go coverage report
description: 'This action updates adds an HTML coverage report and SVG badge to your wiki.'

on:
  workflow_call:
    inputs:
      coverage-file:
        description: 'Coverage input file. By default, generate coverage for all packages in the current module.'
		type: string
      module-dir:
        description: 'The module root directory, containing the go.mod file. By default, the repositorys root directory.'
		type: string
      output-dir:
        description: 'Output directory for the badge, report, chart, etc, relative to the wikis root directory. By default, the wikis root directory.'
		type: string
      badge-style:
        description: 'Badge style generated by shields.io (one of flat, flat-square, plastic, for-the-badge, social).'
        default: 'flat'
		type: string
      badge-title:
        description: 'Badge title generated by shields.io.'
        default: 'coverage'
		type: string
      report:
        description: 'Generate an HTML coverage report.'
        default: true
		type: boolean
      chart:
        description: 'Generate a coverage over time chart.'
        default: false
		type: boolean
      amend:
        description: 'Amend wiki, avoiding spurious commits.'
        default: false
		type: boolean

jobs:

  coverage:
   runs-on: ubuntu-latest
   steps:
    - name: Checkout code
      uses: actions/checkout@v4
      if: |
        hashFiles('.github') == '' &&
        inputs.coverage-file == ''        

    - name: Checkout wiki
      uses: actions/checkout@v4
      with:
        repository: ${{github.repository}}.wiki
        path: ./.github/wiki/

    - name: Generate coverage report
      shell: bash
      env:
        INPUT_COVERAGE: ${{inputs.coverage-file}}
        INPUT_MODULE: ${{inputs.module-dir}}
        INPUT_REPORT: ${{inputs.report}}
        INPUT_CHART: ${{inputs.chart}}
        INPUT_BADGE_STYLE: ${{inputs.badge-style}}
        INPUT_BADGE_TITLE: ${{inputs.badge-title}}
      run: |
        ${{github.action_path}}/coverage.sh ./.github/wiki/${{inputs.output-dir}}

    - name: Push to wiki
      shell: bash
      env:
        INPUT_AMEND: ${{inputs.amend}}
      run: |
        ${{github.action_path}}/push.sh ./.github/wiki/
